sap.ui.define(["sap/ui/core/UIComponent","sap/ui/Device","wasteManagement/workflowuimodule/model/models","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/Label","sap/m/MessageBox","sap/m/MessageToast","sap/m/Text","sap/m/TextArea","sap/ui/core/Core","sap/m/upload/UploadSet","sap/ui/core/Fragment","sap/ui/unified/FileUploaderParameter","sap/m/library"],function(e,t,s,n,o,a,i,r,l,c,u,p,g,d,h,m,f){"use strict";return e.extend("wasteManagement.workflowuimodule.Component",{metadata:{manifest:"json"},init:function(){e.prototype.init.apply(this,arguments);this.getRouter().initialize();this.setModel(s.createDeviceModel(),"device");this.setTaskModels();this.getInboxAPI().addAction({action:"APPROVE",label:"Approve",type:"accept"},function(){this.completeTask(true)},this);this.getInboxAPI().addAction({action:"REJECT",label:"Reject",type:"reject"},function(){this.onShowActionDialog()},this)},setTaskModels:function(){var e=this.getComponentData().startupParameters;this.setModel(e.taskModel,"task");var t=new sap.ui.model.json.JSONModel(this._getTaskInstancesBaseURL()+"/context");this.setModel(t,"context")},_getTaskInstancesBaseURL:function(){return this._getWorkflowRuntimeBaseURL()+"/task-instances/"+this.getTaskInstanceID()},_getWorkflowRuntimeBaseURL:function(){var e=this.getManifestEntry("/sap.app/id");var t=e.replaceAll(".","/");var s=jQuery.sap.getModulePath(t);return s+"/bpmworkflowruntime/v1"},getTaskInstanceID:function(){return this.getModel("task").getData().InstanceID},getInboxAPI:function(){var e=this.getComponentData().startupParameters;return e.inboxAPI},completeTask:function(e){this.getModel("context").setProperty("/approved",e);this._patchTaskInstance();this._refreshTaskList()},_patchTaskInstance:function(){var e={status:"COMPLETED",context:this.getModel("context").getData()};jQuery.ajax({url:this._getTaskInstancesBaseURL(),method:"PATCH",contentType:"application/json",async:false,data:JSON.stringify(e),headers:{"X-CSRF-Token":this._fetchToken()}})},_fetchToken:function(){var e;jQuery.ajax({url:this._getWorkflowRuntimeBaseURL()+"/xsrf-token",method:"GET",async:false,headers:{"X-CSRF-Token":"Fetch"},success(t,s,n){e=n.getResponseHeader("X-CSRF-Token")}});return e},_refreshTaskList:function(){this.getInboxAPI().updateTask("NA",this.getTaskInstanceID())},onShowActionDialog:function(){const e=this.getRootControl();this.getModel("context").setProperty("/comments","");let t="";if(!e.byId("userActionDialog")){h.load({id:e.getId(),name:"wasteManagement.workflowuimodule.fragment.comments",controller:this}).then(function(s){e.addDependent(s);t=s.getContent()[0].getContent()[1];t.setValueState("None");t.setValueStateText("");s.open()}.bind(this))}else{t=e.byId("userActionDialog").getContent()[0].getContent()[1];t.setValueState("None");t.setValueStateText("");e.byId("userActionDialog").open()}},onConfirmUserActionDialog:function(e){const t=e.getSource();const s=t.getParent();const n=s.getTitle();const o=this.getModel("context");const a=s.getContent()[0].getContent()[1];let i="";let r=this.oI18n.getText("msgValueStateDocMandatoryField");let l=this.oI18n.getText("msgValueStateSpecialChars");let c=this.oI18n.getText("msgValueStateMandatoryFields");a.setValueStateText("");let u=new RegExp(/[^A-Za-z0-9\-\_\.\,\$\s]/);let p=false;if(!p){a.setValueState("None");a.setValueStateText("");o.setProperty("/approverDecision","REJECT");s.close();let e=o.getProperty("/comments");let t=btoa(e);o.setProperty("/comments",t);this.completeTask(false)}else{a.setValueState("Error");a.setValueStateText(l)}},onCloseUserActionDialog:function(e){this.getModel("context").setProperty("/comments","");e.getSource().getParent().close()},onAfterRendering:function(){this.oI18n=this.getModel("i18n").getResourceBundle()}})});